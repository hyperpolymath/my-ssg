// SPDX-License-Identifier: AGPL-3.0-or-later
// SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
= NoteG Cookbook
:toc: left
:toclevels: 4
:icons: font
:source-highlighter: rouge
:sectlinks:
:sectanchors:

A comprehensive collection of recipes for CLI commands, Nickel configurations,
Just tasks, Git hooks, and CI/CD pipelines.

== Quick Navigation

* <<cli-recipes,CLI Recipes>>
* <<nickel-recipes,Nickel Configuration Recipes>>
* <<just-recipes,Just Task Recipes>>
* <<hooks-recipes,Git Hooks Recipes>>
* <<cicd-recipes,CI/CD Pipeline Recipes>>

[#cli-recipes]
== CLI Recipes

=== Basic Commands

==== Initialize a New Site

[source,bash]
----
# Create a new NoteG site
deno run --allow-all ssg/src/init.ts my-site

# With specific template
deno run --allow-all ssg/src/init.ts my-site --template blog
----

==== Build Site

[source,bash]
----
# Standard build
just build

# Build with verbose output
LOG_LEVEL=debug just build

# Production build
NODE_ENV=production just build
----

==== Development Server

[source,bash]
----
# Start on default port (8080)
just serve

# Start on custom port
just serve 3000

# With live reload
just watch
----

=== Language Commands

==== Compile NoteG Files

[source,bash]
----
# Compile single file
just compile content/page.noteg

# Compile to specific output
deno run --allow-all noteg-lang/src/compiler.ts \
  --input content/page.noteg \
  --output dist/page.js
----

==== Parse and Inspect

[source,bash]
----
# Show AST
just parse content/page.noteg

# Interpret directly
just interpret content/page.noteg
----

==== Language Server

[source,bash]
----
# Start LSP server
just lsp

# With debug mode
MCP_DEBUG=true just lsp
----

=== Adapter Commands

==== List Available Adapters

[source,bash]
----
# Show all adapters
ls adapters/*.js | xargs -I {} basename {} .js
----

==== Test Adapter Connection

[source,bash]
----
# Test Zola adapter
deno eval "
  import * as zola from './adapters/zola.js';
  console.log('Connected:', await zola.connect());
"
----

=== Accessibility Commands

==== Validate Schemas

[source,bash]
----
# Validate all a11y metadata
just a11y-validate

# Validate specific file
deno run --allow-read a11y/validate.ts content/page.md
----

==== Generate Report

[source,bash]
----
# Full accessibility report
just a11y-report

# WCAG compliance report
deno run --allow-all a11y/report.ts --wcag AA
----

=== Combinatorics & Permutations

==== Build Matrix

[source,bash]
----
# Build for all environments
for env in development staging production; do
  NODE_ENV=$env just build
done

# Test all adapters
for adapter in adapters/*.js; do
  deno test "$adapter" --allow-all
done
----

==== Parallel Execution

[source,bash]
----
# Run tests in parallel
deno test --parallel tests/

# Build and test in parallel
just build & just test & wait
----

[#nickel-recipes]
== Nickel Configuration Recipes

=== Basic Configuration

==== Site Configuration Schema

[source,nickel]
----
# nickel/schema.ncl
{
  SiteConfig = {
    name | String,
    version | String,
    site | {
      title | String,
      description | String,
      url | String,
      language | String | default = "en-GB",
    },
    build | {
      contentDir | String | default = "content",
      templatesDir | String | default = "templates",
      outputDir | String | default = "_site",
      clean | Bool | default = true,
    },
    features | {
      accessibility | Bool | default = true,
      bsl | Bool | default = false,
      gsl | Bool | default = false,
      asl | Bool | default = false,
      makaton | Bool | default = false,
    },
  }
}
----

==== Generate Config from Schema

[source,bash]
----
# Generate JSON config
nickel export nickel/config.ncl > noteg.config.json

# Validate against schema
nickel typecheck nickel/config.ncl
----

=== Build Formulae

==== Build All Formula

[source,nickel]
----
# nickel/formulae/build.ncl
let schema = import "schema.ncl" in
{
  build-all = {
    steps = [
      { name = "engine", command = "just build-engine" },
      { name = "ssg", command = "just build-ssg" },
      { name = "lang", command = "just build-lang" },
    ],
    parallel = true,
  },

  build-production = {
    env = { NODE_ENV = "production" },
    steps = [
      { name = "clean", command = "just clean" },
      { name = "build", command = "just build" },
      { name = "test", command = "just test-all" },
    ],
    parallel = false,
  },
}
----

=== Accessibility Configuration

[source,nickel]
----
# nickel/formulae/accessibility.ncl
{
  a11y-config = {
    wcag-target = "AA",
    supported-languages = ["bsl", "gsl", "asl"],
    makaton-enabled = false,

    validation = {
      strict = true,
      fail-on-warning = false,
    },

    report = {
      format = "html",
      output = "_reports/a11y.html",
    },
  },
}
----

=== Environment Configurations

[source,nickel]
----
# nickel/environments.ncl
{
  development = {
    NODE_ENV = "development",
    LOG_LEVEL = "debug",
    SITE_URL = "http://localhost:8080",
    MCP_DEBUG = "true",
  },

  staging = {
    NODE_ENV = "staging",
    LOG_LEVEL = "info",
    SITE_URL = "https://staging.example.com",
    MCP_DEBUG = "false",
  },

  production = {
    NODE_ENV = "production",
    LOG_LEVEL = "warn",
    SITE_URL = "https://example.com",
    MCP_DEBUG = "false",
  },
}
----

[#just-recipes]
== Just Task Recipes

=== Core Build Tasks

==== Full Build Pipeline

[source,just]
----
# Build everything from scratch
full-build: clean build test
    @echo "Full build complete"

# Incremental build
inc-build:
    @echo "Checking for changes..."
    just build-ssg
----

==== Watch with Rebuild

[source,just]
----
# Watch and rebuild on changes
dev:
    @just watch &
    @just serve
    @wait
----

=== Testing Tasks

==== Coverage Report

[source,just]
----
# Generate and open coverage report
coverage-report: coverage
    @open .coverage/html/index.html 2>/dev/null || \
     xdg-open .coverage/html/index.html 2>/dev/null || \
     echo "Open .coverage/html/index.html manually"
----

==== Mutation Testing

[source,just]
----
# Run mutation tests (requires deno-mutants)
mutation-test:
    @echo "Running mutation tests..."
    deno-mutants tests/unit/
----

=== Release Tasks

==== Semantic Release

[source,just]
----
# Create semantic version release
release-patch:
    @./scripts/bump-version.sh patch
    @just changelog
    @git add -A
    @git commit -m "chore(release): patch release"
    @git push --follow-tags

release-minor:
    @./scripts/bump-version.sh minor
    @just changelog
    @git add -A
    @git commit -m "chore(release): minor release"
    @git push --follow-tags

release-major:
    @./scripts/bump-version.sh major
    @just changelog
    @git add -A
    @git commit -m "chore(release): major release"
    @git push --follow-tags
----

=== Utility Tasks

==== Update Dependencies

[source,just]
----
# Update all dependencies
deps-update:
    @echo "Updating dependencies..."
    deno cache --reload ssg/src/*.ts
    deno cache --reload noteg-lang/src/*.ts
----

==== Check Security

[source,just]
----
# Run security checks
security-check: audit lint
    @echo "Running CodeQL locally..."
    codeql database create .codeql-db --language=javascript
    codeql analyze .codeql-db --format=sarif-latest --output=security-report.sarif
----

[#hooks-recipes]
== Git Hooks Recipes

=== Pre-commit Hook

[source,bash]
----
#!/bin/sh
# .git/hooks/pre-commit
# SPDX-License-Identifier: AGPL-3.0-or-later

set -e

echo "Running pre-commit checks..."

# Format code
echo "Formatting..."
just fmt

# Lint
echo "Linting..."
just lint

# Run unit tests
echo "Testing..."
just test-unit

# Check for secrets
echo "Checking for secrets..."
grep -rn --include="*.ts" --include="*.js" --include="*.res" \
  -E "(password|secret|api_key|token)\s*=\s*['\"][^'\"]+['\"]" . && \
  { echo "Potential secret found!"; exit 1; } || true

echo "Pre-commit checks passed!"
----

=== Pre-push Hook

[source,bash]
----
#!/bin/sh
# .git/hooks/pre-push
# SPDX-License-Identifier: AGPL-3.0-or-later

set -e

echo "Running pre-push checks..."

# Run all tests
just test-all

# Check coverage threshold
COVERAGE=$(deno coverage .coverage --summary | grep "Total" | awk '{print $2}' | tr -d '%')
if [ "$COVERAGE" -lt 70 ]; then
  echo "Coverage ($COVERAGE%) below threshold (70%)"
  exit 1
fi

# Audit dependencies
just audit || true

echo "Pre-push checks passed!"
----

=== Commit-msg Hook

[source,bash]
----
#!/bin/sh
# .git/hooks/commit-msg
# SPDX-License-Identifier: AGPL-3.0-or-later

# Validate conventional commit format
commit_regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,72}'

if ! grep -qE "$commit_regex" "$1"; then
  echo "Invalid commit message format!"
  echo "Expected: type(scope): description"
  echo "Types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
  exit 1
fi
----

=== Post-merge Hook

[source,bash]
----
#!/bin/sh
# .git/hooks/post-merge
# SPDX-License-Identifier: AGPL-3.0-or-later

echo "Running post-merge tasks..."

# Check if dependencies changed
if git diff HEAD@{1} --name-only | grep -qE "(deno.json|package.json|.tool-versions)"; then
  echo "Dependencies may have changed. Running install..."
  asdf install 2>/dev/null || true
  deno cache --reload ssg/src/*.ts 2>/dev/null || true
fi

echo "Post-merge complete!"
----

[#cicd-recipes]
== CI/CD Pipeline Recipes

=== Main CI Workflow

[source,yaml]
----
# .github/workflows/ci.yml
# SPDX-License-Identifier: AGPL-3.0-or-later
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

env:
  DENO_VERSION: 2.1.4

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: denoland/setup-deno@e95548e56dfa95d6e0c8f82effadec16c3536488 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}
      - run: deno lint
      - run: deno fmt --check

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: denoland/setup-deno@e95548e56dfa95d6e0c8f82effadec16c3536488 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}
      - name: Run tests
        run: deno test --allow-all --coverage=.coverage tests/
      - name: Generate coverage
        run: deno coverage .coverage --lcov > coverage.lcov
      - name: Check coverage threshold
        run: |
          COVERAGE=$(deno coverage .coverage --summary | tail -1 | awk '{print $2}' | tr -d '%')
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "Coverage $COVERAGE% is below 70%"
            exit 1
          fi

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: denoland/setup-deno@e95548e56dfa95d6e0c8f82effadec16c3536488 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}
      - run: deno test --allow-all tests/e2e/

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: denoland/setup-deno@e95548e56dfa95d6e0c8f82effadec16c3536488 # v2.0.2
        with:
          deno-version: ${{ env.DENO_VERSION }}
      - uses: extractions/setup-just@dd310ad5a97d8e7b41793f8ef055398d51ad4de6 # v2.0.0
      - run: just build
----

=== Release Workflow

[source,yaml]
----
# .github/workflows/release.yml
# SPDX-License-Identifier: AGPL-3.0-or-later
name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      - uses: denoland/setup-deno@e95548e56dfa95d6e0c8f82effadec16c3536488 # v2.0.2
      - uses: extractions/setup-just@dd310ad5a97d8e7b41793f8ef055398d51ad4de6 # v2.0.0

      - name: Build
        run: just build

      - name: Run tests
        run: just test-all

      - name: Create release
        uses: softprops/action-gh-release@c95fe1489396fe8a9eb87c0abf8aa5b2ef267fda # v2.2.1
        with:
          generate_release_notes: true
          files: |
            dist/*

  container:
    runs-on: ubuntu-latest
    needs: release
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Build container
        run: podman build -t my-ssg:${{ github.ref_name }} -f Containerfile .

      - name: Push to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ghcr.io -u ${{ github.actor }} --password-stdin
          podman push my-ssg:${{ github.ref_name }} ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          podman push my-ssg:${{ github.ref_name }} ghcr.io/${{ github.repository }}:latest
----

=== Scheduled Security Scan

[source,yaml]
----
# Part of .github/workflows/codeql.yml
schedule:
  - cron: '42 20 * * 0'  # Weekly on Sunday
----

== Index

=== Commands by Category

[cols="1,2,1"]
|===
|Command |Description |Section

|`just build`
|Build all components
|<<just-recipes>>

|`just test-all`
|Run complete test suite
|<<just-recipes>>

|`just serve`
|Start development server
|<<cli-recipes>>

|`just lsp`
|Start language server
|<<cli-recipes>>

|`just compile`
|Compile NoteG file
|<<cli-recipes>>

|`just a11y-validate`
|Validate accessibility
|<<cli-recipes>>
|===

=== Files Reference

[cols="1,2"]
|===
|File |Purpose

|`Justfile`
|Task automation

|`Mustfile`
|Configuration templates

|`nickel/*.ncl`
|Nickel configurations

|`.github/workflows/*.yml`
|CI/CD pipelines

|`.git/hooks/*`
|Git hooks
|===
